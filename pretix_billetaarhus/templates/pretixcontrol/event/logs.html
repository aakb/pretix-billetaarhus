{% extends "pretixcontrol/items/base.html" %}
{% load i18n %}
{% load staticfiles %}
{% block title %}{% trans "Event logs" %}{% endblock %}
{% block inside %}
    <h1>{% trans "Event logs" %}</h1>
    <form class="form-inline helper-display-inline" action="" method="get">
        <p>
            <select name="user" class="form-control">
                <option value="">{% trans "All actions" %}</option>
                <option value="yes" {% if request.GET.user == "yes" %}selected="selected"{% endif %}>
                    {% trans "Team actions" %}
                </option>
                <option value="no" {% if request.GET.user == "no" %}selected="selected"{% endif %}>
                    {% trans "Customer actions" %}
                </option>
                {% for up in userlist %}
                    {% if up.user__id %}
                        <option value="{{ up.user__id }}"
                                {% if request.GET.user == up.user__id %}selected="selected"{% endif %}>
                            {{ up.user__email }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
            <button class="btn btn-primary" type="submit">{% trans "Filter" %}</button>
        </p>
    </form>
    <ul class="list-group">
        {% for log in logs %}
            <li class="list-group-item logentry">
                <div class="row">
                    <div class="col-lg-2 col-sm-6 col-xs-12">
                        <span class="fa fa-clock-o"></span> {{ log.datetime|date:"SHORT_DATETIME_FORMAT" }}
                        {% if log.shredded %}
                            <span class="fa fa-eraser fa-danger fa-fw"
                                  data-toggle="tooltip"
                                  title="{% trans "Personal data was cleared from this log entry." %}">
                            </span>
                        {% endif %}
                    </div>
                    <div class="col-lg-2 col-sm-6 col-xs-12">
                        {% if log.user %}
                            {% if log.user.is_staff %}
                                <span class="fa fa-id-card fa-danger fa-fw"
                                      data-toggle="tooltip"
                                      title="{% trans "This change was performed by a pretix administrator." %}">
                                </span>
                            {% else %}
                                <span class="fa fa-user fa-fw"></span>
                            {% endif %}
                            {{ log.user.get_full_name }}
                            {% if log.oauth_application %}
                                <br><span class="fa fa-plug fa-fw"></span>
                                {{ log.oauth_application.name }}
                            {% endif %}
                        {% elif log.api_token %}
                            <span class="fa fa-key fa-fw"></span>
                            {{ log.api_token.name }}
                        {% endif %}
                    </div>
                    <div class="col-lg-2 col-sm-12 col-xs-12">
                        {% if log.display_object %}
                            <span class="fa fa-flag"></span> {{ log.display_object|safe }}
                        {% endif %}
                    </div>
                    <div class="col-lg-6 col-sm-12 col-xs-12">
                        {{ log.display }}
                        {% if log.data != '{}' %}
                            <button class="btn btn-default" type="button" data-toggle="modal" data-target="#billet-aarhus-log-data-modal" data-log-title="{{ log.display }}" data-log-data="{{ log.data }}">details</button>
                        {% endif %}
                    </div>
                </div>
            </li>
            {% empty %}
            <div class="list-group-item">
                <em>{% trans "No results" %}</em>
            </div>
        {% endfor %}
    </ul>
    {% include "pretixcontrol/pagination.html" %}

    <div class="modal" id="billet-aarhus-log-data-modal" tabindex="-1" role="dialog" aria-labelledby="billet-aarhus-log-data-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="billet-aarhus-log-data-modal-label">Log data</h4>
                </div>
                <div class="modal-body">
                    <pre class="log-data"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script src="/static/pretix_billetaarhus/logs.js"></script>

{% endblock %}
